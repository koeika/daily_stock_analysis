# 📱 飞书机器人推送使用指南

## 🎯 Webhook 触发机制说明

### ✅ 你当前的配置状态

根据你的 `.env` 配置:
- ✅ **飞书 Webhook**: 已配置
- ✅ **签名验证**: 已启用
- ⚠️ **定时任务**: 当前 **未启用** (`SCHEDULE_ENABLED=false`)

---

## 🚀 三种运行方式

### 方式一：手动触发（推荐测试用）

每次需要分析时,手动运行命令:

```bash
# 完整分析（股票 + 大盘复盘）
python3 main.py

# 仅分析股票
python3 main.py --no-market-review

# 仅大盘复盘
python3 main.py --market-review

# 指定特定股票
python3 main.py --stocks 159636,159740
```

**触发时机**: 你手动运行命令时
**推送时机**: 分析完成后立即推送到飞书

---

### 方式二：本地定时任务（适合本地Mac常开机）

#### 步骤1: 修改 `.env` 配置

```bash
# 启用定时任务
SCHEDULE_ENABLED=true

# 设置每天执行时间（24小时制）
SCHEDULE_TIME=18:00

# 是否启用大盘复盘
MARKET_REVIEW_ENABLED=true
```

#### 步骤2: 启动定时服务

```bash
# 启动定时任务（程序会保持运行）
python3 main.py --schedule
```

**触发时机**: 每天 18:00 自动执行
**推送时机**: 分析完成后自动推送到飞书
**注意**: 需要保持程序运行,建议使用 `nohup` 或 `screen`

```bash
# 后台运行（推荐）
nohup python3 main.py --schedule > schedule.log 2>&1 &

# 查看日志
tail -f schedule.log
```

---

### 方式三：GitHub Actions 云端定时（推荐，无需本地运行）

#### 优势
- ✅ **零成本**: GitHub Actions 免费额度充足
- ✅ **无需本地**: 不需要电脑一直开着
- ✅ **稳定可靠**: 云端自动执行

#### 配置步骤

**1. Fork 本仓库到你的 GitHub**

点击仓库右上角 `Fork` 按钮

**2. 配置 GitHub Secrets**

进入你 Fork 的仓库:
```
Settings → Secrets and variables → Actions → New repository secret
```

需要配置的 Secrets（从你的 .env 文件复制）:

| Secret 名称 | 值（从你的.env复制） |
|------------|-------------------|
| `OPENAI_API_KEY` | `sk-bf0c1ee9fb4c46cc8c9ea62a14d03a21` |
| `OPENAI_BASE_URL` | `https://api.deepseek.com/v1` |
| `OPENAI_MODEL` | `deepseek-chat` |
| `FEISHU_WEBHOOK_URL` | `https://open.feishu.cn/open-apis/bot/v2/hook/79791...` |
| `FEISHU_WEBHOOK_SECRET` | `Gf55G2oRdxXqMtULRAGBY` |
| `STOCK_LIST` | `159636,159740,159928,588920,516270,159525,512980` |

**3. 启用 GitHub Actions**

```
Actions 标签 → I understand my workflows, go ahead and enable them
```

**4. 查看定时配置**

定时任务已配置为:
- ⏰ **每周一到周五 18:00** (北京时间)
- 📅 **周末不执行**

**触发时机**: 
- 自动: 工作日每天 18:00
- 手动: Actions 页面点击 "Run workflow"

**推送时机**: 分析完成后自动推送到飞书

---

## 📊 推送内容说明

### 完整报告包含

1. **决策仪表盘总览**
   - 分析股票数量
   - 买入/观望/卖出统计

2. **每只股票详细分析**
   - 📰 重要信息速览
   - 💭 舆情情绪
   - 📊 业绩预期
   - 🚨 风险警报
   - ✨ 利好催化
   - 🎯 操作建议（买入价/止损价/目标价）

3. **大盘复盘**（可选）
   - 主要指数表现
   - 市场概况
   - 板块表现

### 推送模式

#### 模式一：汇总推送（默认）
所有股票分析完成后,一次性推送完整报告

```bash
# .env 配置
# SINGLE_STOCK_NOTIFY=false  # 默认,可以不设置
```

#### 模式二：单股推送
每分析完一只股票立即推送,适合监控重点股票

```bash
# .env 配置
SINGLE_STOCK_NOTIFY=true
```

---

## 🔧 常用命令速查

```bash
# 手动触发一次分析（测试用）
python3 main.py

# 启动本地定时任务（需要修改 .env 中 SCHEDULE_ENABLED=true）
python3 main.py --schedule

# 仅测试推送（不做分析）
python3 test_feishu_simple.py

# 发送样例分析报告（看效果）
python3 send_sample_analysis.py

# 查看帮助
python3 main.py --help
```

---

## 📝 配置文件说明

### .env 文件关键配置

```bash
# ============================================
# 定时任务配置
# ============================================
SCHEDULE_ENABLED=false     # 是否启用本地定时任务
SCHEDULE_TIME=18:00        # 执行时间（24小时制）
MARKET_REVIEW_ENABLED=true # 是否启用大盘复盘

# ============================================
# 飞书配置
# ============================================
FEISHU_WEBHOOK_URL=https://...   # Webhook地址
FEISHU_WEBHOOK_SECRET=xxx        # 签名密钥（可选）
FEISHU_MAX_BYTES=20000          # 消息长度限制

# ============================================
# 报告配置
# ============================================
REPORT_TYPE=full                # 报告类型：simple/full
SINGLE_STOCK_NOTIFY=false       # 单股推送模式
ANALYSIS_DELAY=10               # 分析间隔（秒）

# ============================================
# 股票列表
# ============================================
STOCK_LIST=159636,159740,159928,588920,516270,159525,512980
```

---

## ❓ 常见问题

### Q1: 我想每天自动推送,但不想让电脑一直开着?
**A**: 使用 **GitHub Actions** (方式三),云端自动执行,完全免费

### Q2: 如何修改推送时间?
**A**: 
- **本地运行**: 修改 `.env` 中的 `SCHEDULE_TIME=18:00`
- **GitHub Actions**: 修改 `.github/workflows/daily_analysis.yml` 中的 cron 表达式

### Q3: 推送失败了怎么办?
**A**: 检查以下几点:
1. Webhook URL 是否正确
2. 签名密钥是否正确（如果配置了）
3. 机器人是否已添加到飞书群
4. 查看日志: `tail -f logs/stock_analysis_*.log`

### Q4: 想立即测试一次推送?
**A**: 运行测试脚本:
```bash
# 简单测试
python3 test_feishu_simple.py

# 完整分析
python3 main.py
```

### Q5: GitHub Actions 什么时候执行?
**A**: 
- **自动**: 每周一到周五 18:00 (北京时间)
- **手动**: 进入 Actions 页面随时触发

---

## 🎯 推荐使用方案

### 新手推荐（先测试）
1. 运行 `python3 main.py` 手动测试一次
2. 确认推送正常后,配置 GitHub Actions
3. 设置为每天 18:00 自动推送

### 进阶用户（本地运行）
1. 修改 `.env` 启用定时任务
2. 使用 `nohup python3 main.py --schedule &` 后台运行
3. 配合 crontab 开机自启

### 专业用户（Docker部署）
1. 使用 Docker Compose 部署
2. 同时运行 Web UI 和定时任务
3. 配合 Nginx 反向代理

---

## 📚 相关文档

- [完整配置指南](docs/full-guide.md)
- [常见问题FAQ](docs/FAQ.md)
- [更新日志](docs/CHANGELOG.md)
- [贡献指南](docs/CONTRIBUTING.md)

---

## 💡 小贴士

1. **首次运行建议**先用 `--dry-run` 测试数据获取
   ```bash
   python3 main.py --dry-run
   ```

2. **调试时启用详细日志**
   ```bash
   python3 main.py --debug
   ```

3. **GitHub Actions 手动触发**非常方便测试

4. **报告类型选择**:
   - `REPORT_TYPE=simple`: 精简版,适合移动端查看
   - `REPORT_TYPE=full`: 完整版,**推荐飞书**,格式更丰富

5. **搜索 API 可选但推荐配置**:
   - 可以获取最新新闻和舆情
   - Tavily 有免费额度,建议申请

---

**当前状态**: 
- ✅ 飞书配置完成
- ⏳ 定时任务未启用（需要时可开启）
- 🎯 可以手动运行 `python3 main.py` 立即获取分析报告

祝投资顺利! 📈
