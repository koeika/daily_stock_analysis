# 📊 飞书推送触发机制图解

## 🎯 核心问题：Webhook 是如何触发的？

---

## 📋 三种触发方式对比

```
┌─────────────────────────────────────────────────────────────────┐
│                        触发方式对比表                              │
├──────────┬──────────────┬──────────────┬─────────────────────┤
│ 方式     │ 触发时机      │ 推送时机      │ 适用场景             │
├──────────┼──────────────┼──────────────┼─────────────────────┤
│ 手动触发 │ 你运行命令时  │ 分析完成立即  │ 测试、按需分析        │
│ 本地定时 │ 每天18:00     │ 分析完成自动  │ Mac常开机            │
│ GitHub   │ 云端18:00     │ 分析完成自动  │ 推荐！零成本无维护    │
└──────────┴──────────────┴──────────────┴─────────────────────┘
```

---

## 🔄 工作流程图

### 方式1: 手动触发

```
你 → 运行命令 → 程序启动 → 获取数据 → AI分析 → 生成报告 → 调用Webhook → 飞书收到消息
    python3          ↓          ↓        ↓        ↓         ↓           ↓
    main.py        启动       行情数据   智能分析  Markdown  HTTP POST    📱
                   日志       新闻舆情   买卖建议  格式化    签名验证     推送
```

**时间线**:
```
00:00 - 你运行命令
00:05 - 获取7只ETF数据
00:30 - AI分析第1只股票
01:00 - AI分析第2只股票
...
03:30 - AI分析第7只股票
03:35 - 生成完整报告
03:36 - 推送到飞书 ✅
03:37 - 你收到消息 📱
```

---

### 方式2: 本地定时任务

```
                                   ┌─────────────────┐
                                   │   每天 18:00    │
                                   │  定时器触发     │
                                   └────────┬────────┘
                                            ↓
┌──────────────────────────────────────────────────────────────────┐
│                         程序运行中                                 │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐│
│  │ 获取数据   │→ │ AI 分析    │→ │ 生成报告   │→ │ 推送飞书   ││
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘│
└──────────────────────────────────────────────────────────────────┘
                                            ↓
                                    ┌────────────────┐
                                    │   飞书收到消息   │
                                    │      📱         │
                                    └────────────────┘
```

**时间线**:
```
17:59:59 - 程序等待中 ⏳
18:00:00 - 定时器触发 🔔
18:00:05 - 开始获取数据
18:03:36 - 分析完成
18:03:37 - 推送到飞书 ✅
18:03:38 - 你收到消息 📱
```

**启用方式**:
```bash
# 1. 修改 .env
SCHEDULE_ENABLED=true

# 2. 启动服务
python3 main.py --schedule
```

---

### 方式3: GitHub Actions（推荐）

```
                    GitHub 云端服务器
┌─────────────────────────────────────────────────────────────┐
│                                                               │
│  ⏰ 每周一到五 18:00 (北京时间)                              │
│      ↓                                                        │
│  🔔 定时器自动触发                                           │
│      ↓                                                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 1. 检出代码                                          │   │
│  │ 2. 安装依赖                                          │   │
│  │ 3. 读取 Secrets (FEISHU_WEBHOOK_URL, API_KEY...)    │   │
│  │ 4. 运行 python main.py                               │   │
│  │    ├─ 获取股票数据                                    │   │
│  │    ├─ AI 智能分析                                     │   │
│  │    ├─ 生成报告                                        │   │
│  │    └─ 推送到飞书 ✅                                   │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                           ↓
                   ┌────────────────┐
                   │  飞书收到消息   │
                   │      📱         │
                   └────────────────┘
```

**时间线**:
```
17:59:59 - GitHub 等待触发 ⏳
18:00:00 - Actions 自动启动 🚀
18:00:15 - 环境准备完成
18:00:20 - 开始数据获取
18:03:56 - 分析完成
18:03:57 - 推送到飞书 ✅
18:03:58 - 你收到消息 📱
```

**配置步骤**:
```
1. Fork 仓库 → https://github.com/ZhuLinsen/daily_stock_analysis
2. Settings → Secrets → 添加配置
3. Actions → Enable workflows
4. 完成! 🎉
```

---

## 🔍 Webhook 调用详解

### 推送流程

```
程序生成报告
    ↓
构建飞书卡片格式 (JSON)
    ↓
添加签名验证 (HMAC-SHA256)
    ↓
HTTP POST → https://open.feishu.cn/open-apis/bot/v2/hook/xxx
    ↓
飞书服务器验证签名
    ↓
✅ 验证通过 → 消息推送到群组
❌ 验证失败 → 返回错误
```

### 请求格式

```json
{
  "msg_type": "interactive",
  "timestamp": "1676280000",
  "sign": "xxx...",
  "card": {
    "header": {
      "title": {
        "content": "📊 A股智能分析报告"
      }
    },
    "elements": [{
      "tag": "div",
      "text": {
        "tag": "lark_md",
        "content": "# 决策仪表盘\n..."
      }
    }]
  }
}
```

---

## ⚙️ 你的当前配置

```
┌──────────────────────────────────────────┐
│          当前配置状态                     │
├──────────────────────────────────────────┤
│ ✅ 飞书 Webhook     │ 已配置             │
│ ✅ 签名验证         │ 已启用             │
│ ✅ AI 模型          │ DeepSeek           │
│ ✅ 股票列表         │ 7只ETF             │
│ ⏳ 本地定时任务     │ 未启用             │
│ ⏳ GitHub Actions   │ 待配置             │
└──────────────────────────────────────────┘
```

---

## 🚀 快速开始

### 立即测试（手动触发）

```bash
# 方式1: 使用快捷脚本
./start.sh
# 选择 1) 完整分析

# 方式2: 直接命令
python3 main.py
```

预计 3-5 分钟后收到飞书消息 📱

---

### 启用自动化（推荐GitHub）

```
第1步: Fork仓库
   ↓
第2步: 配置Secrets
   ├─ OPENAI_API_KEY
   ├─ FEISHU_WEBHOOK_URL
   └─ STOCK_LIST
   ↓
第3步: 启用Actions
   ↓
第4步: 完成! 每天18:00自动推送 ✅
```

---

## 📱 消息示例

你会收到这样的消息:

```
┌────────────────────────────────────────┐
│  📊 A股智能分析 - 每日决策仪表盘        │
├────────────────────────────────────────┤
│                                        │
│  🎯 2026-02-13 决策仪表盘               │
│  共分析7只ETF | 🟢买入:2 🟡观望:4      │
│                                        │
│  📊 分析结果摘要                        │
│  ⚪ 港科技30: 观望 | 评分 68           │
│  🟢 消费ETF: 买入 | 评分 75            │
│  ...                                   │
│                                        │
│  🎯 操作建议                            │
│  - 买入价: ¥2.850                      │
│  - 止损价: ¥2.750                      │
│  - 目标价: ¥3.050                      │
│                                        │
│  📊 市场概况                            │
│  - 上证指数: +0.85% 🟢                 │
│  - 深证成指: +1.02% 🟢                 │
│                                        │
└────────────────────────────────────────┘
```

---

## ❓ 常见问题

**Q: 现在运行会推送吗?**
A: 是! 运行 `python3 main.py` 分析完就推送。

**Q: 如何每天自动推送?**
A: 配置 GitHub Actions (推荐) 或启用本地定时。

**Q: 推送时间能改吗?**
A: 能! 本地改 .env，GitHub 改 workflow 文件。

**Q: 能立即看到效果吗?**
A: 能! 运行 `python3 test_feishu_simple.py`。

---

## 📚 完整文档

- [配置完成总结.md](./配置完成总结.md) - **详细总结**
- [飞书推送使用指南.md](./飞书推送使用指南.md) - 使用说明
- [快速开始.md](./快速开始.md) - 快速上手

---

**现在就试试吧!** 🚀

```bash
python3 main.py
```

等待 3-5 分钟,飞书会收到你的第一份股票分析报告! 📱📈
