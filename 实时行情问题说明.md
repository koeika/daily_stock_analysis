# 📊 实时行情获取失败问题说明

## 🔍 问题现象

在 GitHub Actions 运行时，经常看到这样的错误：

```
WARNING | [API错误] ak.fund_etf_spot_em 获取失败: 
('Connection aborted.', RemoteDisconnected('Remote end closed connection without response'))

ERROR | 获取 ETF 实时行情(efinance)失败: 
HTTPConnectionPool(host='push2.eastmoney.com', port=80): Max retries exceeded
```

---

## 🎯 根本原因

### 1. **GitHub Actions 服务器位置**
- GitHub Actions 的服务器在**境外**（美国、欧洲等）
- 访问国内股票数据源（东方财富、新浪财经等）**网络不稳定**

### 2. **数据源限制**
国内数据源可能对境外 IP：
- 🚫 有访问限制
- 🐌 连接速度慢
- ❌ 频繁断开连接

### 3. **影响的数据源**
- `push2.eastmoney.com` - 东方财富实时行情
- `akshare` - 调用东财接口
- 其他国内数据接口

---

## ✅ 解决方案

### **已采取的措施**

#### 1. **禁用实时行情获取** ⭐ 推荐

修改 `src/config.py`：

```python
# 实时行情开关（关闭后使用历史收盘价进行分析）
enable_realtime_quote: bool = False  # 改为 False

# 筹码分布开关（该接口不稳定，云端部署建议关闭）
enable_chip_distribution: bool = False  # 改为 False
```

**为什么这样做？**

| 推送时间 | 是否需要实时行情 | 说明 |
|---------|---------------|------|
| **18:00** | ❌ **不需要** | 市场已收盘，使用历史收盘价即可 |
| 08:30 | ⚠️ 可选 | 开盘前，实时行情用处不大 |
| 盘中 | ✅ 需要 | 如果要做盘中分析 |

**你当前配置是 18:00 盘后推送**，所以：
- ✅ 使用历史收盘价**完全够用**
- ✅ 分析质量**不受影响**
- ✅ 运行速度**更快**
- ✅ **避免网络错误**

#### 2. **自动降级机制** ✅ 已内置

系统已经有自动降级逻辑：

```python
# 如果实时行情获取失败
if realtime_data is None:
    logger.info("[159636] 实时行情获取失败或已禁用，将使用历史数据进行分析")
    # 使用历史收盘价继续分析
```

**即使不修改配置**，系统也会自动使用历史数据，**不会中断分析**。

---

## 🔧 其他可选方案

### **方案A：配置代理（需要额外资源）**

如果确实需要实时行情：

1. **准备一个国内代理服务器**
2. **在 GitHub Secrets 中配置**：
   ```
   HTTP_PROXY=http://your-proxy.com:8080
   ```
3. **修改 workflow**：
   ```yaml
   env:
     HTTP_PROXY: ${{ secrets.HTTP_PROXY }}
   ```

**缺点**：
- ❌ 需要额外的代理服务器
- ❌ 增加配置复杂度
- ❌ 代理费用

### **方案B：切换到其他数据源**

使用支持境外访问的数据源：
- Yahoo Finance（yfinance）- 但延迟较大
- Tushare Pro（需要积分）
- 自建数据采集服务

**缺点**：
- ⚠️ 数据可能不完整
- ⚠️ 延迟较大
- ⚠️ 可能需要付费

---

## 📊 对分析质量的影响

### **18:00 盘后推送场景**

| 数据类型 | 使用实时行情 | 使用历史数据 | 影响 |
|---------|------------|------------|------|
| 收盘价 | ✅ 当天 | ✅ 当天 | **无差异** |
| 开盘价 | ✅ 当天 | ✅ 当天 | **无差异** |
| 最高/最低 | ✅ 当天 | ✅ 当天 | **无差异** |
| 成交量 | ✅ 当天 | ✅ 当天 | **无差异** |
| MA5/10/20 | ✅ 完整 | ✅ 完整 | **无差异** |
| 技术指标 | ✅ 完整 | ✅ 完整 | **无差异** |
| 盘中波动 | ✅ 有 | ❌ 无 | 盘后推送不需要 |

**结论**：对于 18:00 盘后推送，使用历史数据**分析质量完全不受影响**！✅

---

## 🎯 推荐配置

### **盘后推送（18:00）** - 当前配置

```python
# src/config.py
enable_realtime_quote: bool = False  # 禁用
enable_chip_distribution: bool = False  # 禁用
schedule_time: str = "18:00"  # 盘后推送
```

✅ **优势**：
- 稳定可靠，无网络错误
- 运行速度快
- 分析质量不受影响
- 适合第二天交易决策

### **如果改为早盘推送（08:30）**

```python
enable_realtime_quote: bool = False  # 仍然禁用
schedule_time: str = "08:30"  # 早盘推送
```

原因：
- 早盘还未开盘，实时行情也是前一日收盘价
- 禁用实时行情不影响分析

---

## 📝 总结

### **为什么不用担心？**

1. ✅ **系统已有自动降级** - 实时行情失败会自动使用历史数据
2. ✅ **历史数据完全够用** - 18:00 推送不需要实时行情
3. ✅ **分析质量不受影响** - 技术指标和趋势判断都基于收盘价
4. ✅ **已禁用实时行情** - 避免网络错误，提升稳定性

### **日志中的警告可以忽略吗？**

✅ **可以！** 这些警告只是说明：
- 系统尝试获取实时行情（按照配置尝试）
- 获取失败后自动降级到历史数据
- 分析正常完成

禁用实时行情后，这些警告就不会再出现了。

---

## 🚀 下一步

1. **已完成**：修改 `src/config.py`，禁用实时行情
2. **待操作**：
   ```bash
   git add src/config.py
   git commit -m "Config: disable realtime quote for GitHub Actions stability"
   git push origin main
   ```
3. **验证**：下次 GitHub Actions 运行时，不会再出现这些网络错误

---

**修复日期**: 2026-02-13  
**问题状态**: ✅ 已优化  
**影响**: 无（分析质量不受影响）
